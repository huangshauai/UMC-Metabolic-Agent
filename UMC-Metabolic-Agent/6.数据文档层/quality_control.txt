# UMC-Metabolic-Agent 质量控制规范文档
# 文件名称：quality_control.txt
# 版本：v2.0
# 适用范围：UMC智能体所有模块、数据集、脚本的开发、测试、部署全流程
# 核心目标：保证系统稳定性、结果可靠性、数据一致性、脚本可复现性

## ==============================================
## 一、核心模块质量控制标准
## ==============================================
### 1.1 模块通用质量要求
| 检查项 | 质量标准 | 检查方法 | 不合格处理 |
|--------|----------|----------|------------|
| 代码规范 | 1. 遵循Python PEP8编码规范<br>2. 关键函数/类添加详细注释<br>3. 变量命名清晰（英文语义化，避免拼音/缩写） | 人工审查 + 代码格式化工具 | 优化代码格式，补充注释 |
| 依赖管理 | 1. 所有依赖明确版本号，写入requirements.txt<br>2. 核心依赖添加容错处理（try-except导入）<br>3. 避免冗余依赖，仅保留必要包 | 检查import语句 + 运行依赖检查脚本 | 移除冗余依赖，补充容错逻辑 |
| 容错机制 | 1. 处理文件不存在、路径错误、数据格式异常等常见异常<br>2. 错误信息清晰，包含具体出错位置和原因<br>3. 单个功能失败不影响整体模块运行 | 模拟异常场景测试（如删除核心文件） | 补充异常捕获逻辑，优化错误提示 |
| 日志记录 | 1. 关键操作（运行/调优/分析）必须记录日志<br>2. 日志包含时间、模块名、操作内容、结果<br>3. 日志同时输出到控制台和文件 | 运行模块，检查日志文件完整性 | 补充关键操作日志，调整日志格式 |

### 1.2 各核心模块专项质量要求
#### （1）通用命令模块（universal_cmd.py）
- 运行功能：输入数据路径验证，支持相对/绝对路径，输出结果包含核心指标
- 分析功能：支持多种分析类型，结果结构化存储，无空值/异常值
- 报告功能：兼容所有数据集格式，生成的报告包含核心指标、图表、优化建议

#### （2）调优仪表盘模块（tuner_dashboard.py）
- 调优参数：有明确的取值范围限制（如学习率0.001-0.1），防止无效参数输入
- 收敛判断：调优过程中实时计算收敛状态，迭代次数达到阈值或得分稳定后自动停止
- 状态监控：tuner_status字典实时更新，包含进度、当前得分、最优得分等关键信息

#### （3）身份认证模块（ext_identity.py）
- 密码安全：采用bcrypt哈希存储，禁止明文存储密码
- 令牌管理：JWT令牌有明确过期时间，刷新令牌机制正常工作
- 权限控制：RBAC角色权限映射准确，不同角色只能访问授权功能

#### （4）API接口模块（custom_app_api.py）
- 接口规范：遵循RESTful标准，请求参数验证严格，响应格式统一
- 异步任务：后台任务执行稳定，任务状态可查询，失败后记录错误原因
- 跨域支持：CORS配置正确，支持前端/外部应用正常调用

## ==============================================
## 二、数据集质量控制标准
## ==============================================
### 2.1 数据集通用质量要求（所有CSV文件）
| 检查项 | 质量标准 | 检查方法 | 不合格处理 |
|--------|----------|----------|------------|
| 字段规范 | 1. 必须包含通用字段：`timestamp`/`sample_id`/`domain_adapt_score`/`core_factor`/`stability`<br>2. 领域特有字段命名清晰，符合领域语义<br>3. 字段顺序合理，无重复/冗余字段 | 用pandas读取，检查列名和字段完整性 | 补充缺失的通用字段，删除冗余字段 |
| 数据合理性 | 1. 数值型字段符合领域物理规律（如量子保真度0.7-0.99，引力场强度1.6-24.8 m/s²）<br>2. 无异常值（如负数、超出合理范围的值）<br>3. 无缺失值，缺失数据用合理方式填充 | 统计分析 + 领域知识验证 | 修正异常值，填充缺失值，删除无效样本 |
| 可复现性 | 1. 生成脚本使用固定随机种子（np.random.seed(42)）<br>2. 多次运行生成脚本，数据结果一致 | 重复运行生成脚本，对比数据MD5值 | 检查随机种子设置，优化数据生成逻辑 |
| 兼容性 | 1. 与UMC智能体所有脚本无缝对接，无需修改代码即可使用<br>2. CSV编码为UTF-8，无乱码，分隔符为逗号 | 直接运行run_quick.py测试兼容性 | 调整字段格式，确保编码正确 |

### 2.2 各领域数据集专项质量要求
#### （1）量子比特数据集（quantum_qubit.csv）
- 核心指标：`quantum_fidelity`范围0.70-0.99，`error_rate`范围0.001-0.05
- 数据关联：比特数越多，`quantum_fidelity`越低，`error_rate`越高（符合物理规律）
- 样本标识：`sample_id`格式为`Q_{比特数}_{序号}`，如Q_2_0001

#### （2）原子光谱数据集（atomic_spectra.csv）
- 核心指标：`spectral_resolution`范围0.001-0.010 nm，`snr`范围100-500
- 数据关联：不同元素的光谱特性符合实际（如H的分辨率高于Na）
- 样本标识：`sample_id`格式为`A_{元素}_{序号}`，如A_H_0001

#### （3）宏观引力数据集（macro_gravity.csv）
- 核心指标：`geodesic_accuracy`范围0.85-0.95，`spacetime_curvature`范围1e-9-2e-8
- 数据关联：天体质量越大，引力场强度越高，时空曲率越大
- 样本标识：`sample_id`格式为`G_{天体}_{序号}`，如G_Earth_0001

## ==============================================
## 三、运行脚本质量控制标准
## ==============================================
### 3.1 脚本通用质量要求
| 检查项 | 质量标准 | 检查方法 | 不合格处理 |
|--------|----------|----------|------------|
| 参数规范 | 1. 所有参数有默认值，支持命令行参数覆盖<br>2. 参数有明确的取值范围，输入验证严格<br>3. 提供--help参数，输出清晰的使用说明 | 运行脚本+--help，测试参数修改效果 | 补充参数默认值，添加参数验证逻辑 |
| 输出规范 | 1. 输出文件集中存储在指定目录（如./umc_quick_output）<br>2. 输出文件名包含时间戳/任务ID，便于区分<br>3. 输出结果包含核心指标、运行时间、状态信息 | 运行脚本，检查输出文件的路径和内容 | 调整输出路径，补充结果指标 |
| 容错性 | 1. 处理文件不存在、权限不足、内存不足等异常<br>2. 运行过程中出现错误，给出明确的解决方案<br>3. 支持断点续跑（批量脚本） | 模拟异常场景测试 | 补充异常处理逻辑，添加断点续跑功能 |
| 文档完整性 | 1. 脚本头部有功能说明、使用方法、参数列表<br>2. 关键代码块有注释，说明实现逻辑<br>3. 提供示例命令，便于用户快速上手 | 人工审查脚本注释和文档 | 补充脚本头部说明，添加关键代码注释 |

### 3.2 各运行脚本专项质量要求
#### （1）快速运行脚本（run_quick.py）
- 功能：支持单任务快速运行/调优/报告生成，无冗余步骤
- 速度：启动时间≤3秒，单任务运行时间≤配置的run_time
- 输出：仅输出核心指标，无冗余日志，结果文件路径清晰

#### （2）批量处理脚本（batch_process.py）
- 并行控制：支持配置并行线程数，避免资源占用过高（CPU利用率≤80%）
- 任务隔离：单个任务失败不影响其他任务，失败原因记录详细
- 汇总报告：批量运行完成后，生成汇总报告，包含成功率、最优任务、领域对比

#### （3）调优示例脚本（example_tuner_operation.py）
- 步骤清晰：分步骤演示调优流程，每步有明确的提示和输出
- 可视化：支持调优过程绘图，图表清晰展示得分变化和收敛点
- 新手友好：提供参数修改建议，输出结果有详细解释

## ==============================================
## 四、智能体运行质量控制标准
## ==============================================
### 4.1 输入验证
1. 数据文件验证：检查文件是否存在、格式是否为CSV、编码是否为UTF-8
2. 参数验证：检查参数是否在合理范围（如迭代次数≥10，学习率≥0.001）
3. 环境验证：检查核心模块是否加载、依赖是否完整、目录权限是否足够

### 4.2 运行过程监控
1. 进度监控：实时输出运行/调优进度，包含当前步骤、耗时、预计剩余时间
2. 资源监控：监控CPU、内存占用，避免资源耗尽（内存占用≤2GB/任务）
3. 日志监控：关键节点记录日志，便于追踪运行过程和排查问题

### 4.3 结果验证标准
1. 核心指标验证：运行结果的核心指标（如代谢效率、保真度）在合理范围
2. 结果完整性：输出文件包含所有必要字段，无缺失数据
3. 可复现性：相同输入参数，多次运行结果一致（误差≤1%）

## ==============================================
## 五、调优质量控制标准
## ==============================================
### 5.1 调优参数范围标准
| 参数名 | 合理范围 | 推荐值 | 超出范围影响 |
|--------|----------|--------|--------------|
| adapt_iterations | 10-500 | 50-100 | 过少：收敛不充分；过多：耗时过长 |
| learning_rate | 0.001-0.1 | 0.008-0.015 | 过小：收敛慢；过大：震荡不收敛 |
| core_factor_weight | 0.1-1.0 | 0.8-0.9 | 影响核心指标的权重，需根据领域调整 |

### 5.2 收敛判断标准
1. 绝对收敛：连续10次迭代得分变化≤0.001
2. 相对收敛：得分达到最优值的99%以上
3. 迭代收敛：达到设定的迭代次数上限

### 5.3 调优结果评估标准
1. 得分提升率：调优后得分相比调优前提升≥5%
2. 稳定性：多次调优的最优得分波动≤2%
3. 实用性：最优参数可直接应用于后续运行，结果稳定

## ==============================================
## 六、质量检查流程
## ==============================================
### 6.1 日常检查流程
1. **模块检查**：启动API服务，访问/docs验证接口是否正常；运行调优仪表盘，验证界面功能
2. **数据集检查**：运行generate_*.py脚本，验证数据生成是否正常；用pandas读取数据，检查字段和数值
3. **脚本检查**：运行run_quick.py run，验证智能体运行是否正常；运行batch_process.py，验证批量处理功能

### 6.2 版本更新检查流程
1. 新增模块/脚本后，检查是否符合本质量规范
2. 修改核心代码后，进行回归测试，确保原有功能不受影响
3. 更新数据集后，验证与所有脚本的兼容性

### 6.3 问题排查流程
1. 记录问题现象、复现步骤、错误日志
2. 根据本规范检查相关模块/数据集/脚本，定位问题原因
3. 修复问题后，进行验证测试，确保问题解决

## ==============================================
## 七、常见质量问题与解决方案
## ==============================================
| 常见问题 | 原因分析 | 解决方案 |
|----------|----------|----------|
| 模块导入失败 | 核心文件不在当前目录；依赖缺失 | 1. 检查文件是否存在；2. 运行pip install安装依赖 |
| 数据生成失败 | 随机种子设置错误；字段名拼写错误 | 1. 检查np.random.seed是否设置；2. 核对字段名是否正确 |
| 调优不收敛 | 学习率过大；迭代次数不足 | 1. 降低学习率（如0.01→0.008）；2. 增加迭代次数 |
| 脚本运行报错 | 参数输入错误；文件路径错误 | 1. 检查参数是否在合理范围；2. 确认文件路径是否正确 |
| 输出结果异常 | 数据存在异常值；核心指标计算错误 | 1. 清理数据中的异常值；2. 检查核心指标计算逻辑 |

## ==============================================
## 八、版本信息与更新日志
## ==============================================
### 版本历史
- v1.0：初始版本，包含模块、数据集、脚本的基础质量标准
- v2.0：新增调优质量标准、质量检查流程、常见问题解决方案

### 更新日志
| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2026-01-18 | v2.0 | 完善质量检查流程和问题解决方案；补充各模块专项质量要求 |

### 维护人员
- 维护主体：UMC-Metabolic-Agent 开发团队
- 反馈渠道：提交问题至项目仓库，或联系维护人员

## ==============================================
## 附录：质量检查工具推荐
## ==============================================
1. **代码规范检查**：pylint、flake8
2. **数据质量检查**：pandas-profiling、Great Expectations
3. **运行监控工具**：psutil（监控CPU/内存）、logging（日志管理）
4. **测试工具**：pytest（单元测试）、requests（API接口测试）